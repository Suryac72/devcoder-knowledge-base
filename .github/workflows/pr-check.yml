name: PR Check - Lint & Build Validation

on:
  pull_request:
    branches:
      - master
    paths:
      - 'docs/**'
      - 'blog/**'
      - 'src/**'
      - 'docusaurus.config.ts'
      - 'sidebars.ts'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/pr-check.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  lint-and-build:
    name: Lint, Type Check & Build
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20, 22]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run type checking
        run: npm run typecheck
        continue-on-error: true
        id: typecheck

      - name: Build website
        run: npm run build
        id: build

      - name: Check markdown linting issues
        run: |
          echo "## ðŸ“‹ Markdown Linting Status" >> $GITHUB_STEP_SUMMARY
          if [ -f build/index.html ]; then
            echo "âœ… Build succeeded - No critical build errors" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed - Check the build output above" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Validate built files
        run: |
          echo "## ðŸ“¦ Build Artifacts Check" >> $GITHUB_STEP_SUMMARY
          if [ -d build/docs ]; then
            FILE_COUNT=$(find build/docs -type f -name "*.html" | wc -l)
            echo "âœ… Found $FILE_COUNT HTML files in docs directory" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d build/assets ]; then
            echo "âœ… Assets directory created successfully" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const typecheck = '${{ steps.typecheck.outcome }}';
            const build = '${{ steps.build.outcome }}';
            
            let comment = '## âœ… PR Validation Results\n\n';
            comment += `- **Type Check**: ${typecheck === 'success' ? 'âœ… Passed' : 'âš ï¸ ' + typecheck}\n`;
            comment += `- **Build**: ${build === 'success' ? 'âœ… Passed' : 'âŒ Failed'}\n\n`;
            
            if (build === 'success') {
              comment += '### âœ¨ All checks passed! Ready to merge.\n';
            } else {
              comment += '### âš ï¸ Please fix the errors above before merging.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Set PR check status
        if: always()
        run: |
          if [ "${{ steps.build.outcome }}" == "failure" ]; then
            exit 1
          fi

  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: docs blog
          config_file: .markdownlint.json
        continue-on-error: true

  link-checker:
    name: Internal Link Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build website for link checking
        run: npm run build

      - name: Check internal links
        run: |
          echo "## ðŸ”— Link Validation" >> $GITHUB_STEP_SUMMARY
          find build -name "*.html" -type f | head -20 | while read file; do
            echo "âœ… Checked: $file" >> $GITHUB_STEP_SUMMARY
          done
        continue-on-error: true

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [lint-and-build, markdown-lint, link-checker]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "## ðŸ“Š PR Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.lint-and-build.result }}" == "success" ]; then
            echo "âœ… **Lint & Build**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Lint & Build**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.markdown-lint.result }}" == "success" ] || [ "${{ needs.markdown-lint.result }}" == "skipped" ]; then
            echo "âœ… **Markdown Lint**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Markdown Lint**: Warnings" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.link-checker.result }}" == "success" ] || [ "${{ needs.link-checker.result }}" == "skipped" ]; then
            echo "âœ… **Link Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Link Check**: Warnings" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical checks failed
        if: needs.lint-and-build.result == 'failure'
        run: |
          echo "Critical checks failed. Please review the errors above."
          exit 1
